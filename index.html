<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecureLogin</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureLogin">
    <meta name="theme-color" content="#007AFF">
    
    <!-- Icons for PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMwMDdBRkYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xOCA4aC0xVjZjMC0yLjc2LTIuMjQtNS01LTVTNyAzLjI0IDcgNnYySDZjLTEuMSAwLTIgLjktMiAydjEwYzAgMS4xLjkgMiAyIDJoMTJjMS4xIDAgMi0uOSAyLTJWMTBjMC0xLjEtLjktMi0yLTJ6TTEyIDE3Yy0xLjEgMC0yLS45LTItMnMuOS0yIDItMiAyIC45IDIgMi0uOSAyLTIgMnpNMTUuMSA4SDguOVY2YzAtMS43MSAxLjM5LTMuMSAzLjEtMy4xczMuMSAxLjM5IDMuMSAzLjF2MnoiLz4KPHN2Zz4KPHN2Zz4=">
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .status-bar-spacer {
            height: env(safe-area-inset-top, 44px);
            background: rgba(0, 0, 0, 0.1);
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #007AFF, #34C759);
            border-radius: 16px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }
        
        .logo svg {
            width: 30px;
            height: 30px;
            fill: white;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .app-subtitle {
            font-size: 16px;
            color: #666;
            font-weight: 400;
        }
        
        .main-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .scanner-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 30px;
            display: none;
        }
        
        .qr-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            border-radius: 20px;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
        }
        
        .welcome-text {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        
        .token-info {
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 30px;
            border-left: 4px solid #007AFF;
        }
        
        .token-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .token-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 16px;
            color: #007AFF;
            font-weight: 600;
            word-break: break-all;
        }
        
        .action-btn {
            background: linear-gradient(45deg, #007AFF, #0056CC);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            margin-bottom: 15px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 122, 255, 0.4);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        .scan-btn {
            background: linear-gradient(45deg, #34C759, #28A745);
            box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
        }
        
        .scan-btn:hover {
            box-shadow: 0 6px 25px rgba(52, 199, 89, 0.4);
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #007AFF;
            border: 2px solid #007AFF;
        }
        
        .video-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            border-radius: 16px;
            overflow: hidden;
            margin: 20px auto;
            position: relative;
            background: #000;
        }
        
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #00FF00;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            animation: scannerPulse 2s infinite;
        }
        
        @keyframes scannerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 380px;
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #34C759, #28A745);
            border-radius: 10px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feature-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
        }
        
        .feature-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        .bottom-spacer {
            height: env(safe-area-inset-bottom, 20px);
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .error-message {
            background: rgba(255, 59, 48, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            border-left: 4px solid #FF3B30;
            color: #FF3B30;
            font-size: 14px;
            text-align: left;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* iPhone 14 Pro Max specific optimizations */
        @media screen and (min-width: 428px) and (min-height: 926px) {
            .main-content {
                padding: 60px 30px;
            }
            
            .welcome-card {
                padding: 50px 40px;
            }
            
            .app-title {
                font-size: 32px;
            }
            
            .welcome-title {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar-spacer"></div>
        
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM15.1 8H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
                </svg>
            </div>
            <h1 class="app-title">SecureLogin</h1>
            <p class="app-subtitle">QR Code Authentication</p>
        </div>
        
        <div class="main-content">
            <!-- Welcome Screen -->
            <div class="welcome-card" id="welcomeScreen">
                <div class="qr-icon">
                    <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                        <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4z"/>
                        <path d="M18 13h-2v2h2v-2zM20 15h-2v2h2v-2zM22 13h-2v2h2v-2zM18 17h-2v2h2v-2zM20 19h-2v2h2v-2zM22 17h-2v4h2v-4z"/>
                    </svg>
                </div>
                
                <h2 class="welcome-title">Welcome!</h2>
                <p class="welcome-text" id="welcomeText">Scan a QR code to authenticate or continue with manual login.</p>
                
                <div class="token-info" id="tokenInfo" style="display: none;">
                    <div class="token-label">Session Token:</div>
                    <div class="token-value" id="tokenValue">Loading...</div>
                </div>
                
                <button class="action-btn scan-btn" id="scanBtn" onclick="startQRScanner()">
                    Scan QR Code
                </button>
                
                <button class="action-btn" id="loginBtn" onclick="handleManualLogin()">
                    Manual Login
                </button>
            </div>
            
            <!-- QR Scanner Screen -->
            <div class="scanner-card" id="scannerScreen">
                <h2 class="welcome-title">Scan QR Code</h2>
                <p class="welcome-text">Point your camera at the QR code</p>
                
                <div class="video-container">
                    <video id="qr-video" playsinline></video>
                    <div class="scanner-overlay"></div>
                </div>
                
                <div class="error-message hidden" id="errorMessage"></div>
                
                <button class="action-btn secondary-btn" onclick="stopQRScanner()">
                    Cancel Scan
                </button>
            </div>
            
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Secure</div>
                    <div class="feature-desc">End-to-end encrypted authentication</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Fast</div>
                    <div class="feature-desc">Quick QR code recognition</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Reliable</div>
                    <div class="feature-desc">99.9% uptime guarantee</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 6L12 10.5 8.5 8 12 5.5 15.5 8zM8.5 16L12 13.5 15.5 16 12 18.5 8.5 16z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Smart</div>
                    <div class="feature-desc">AI-powered security</div>
                </div>
            </div>
        </div>
        
        <div class="bottom-spacer"></div>
    </div>

    <script>
        let qrScanner = null;
        let scannerActive = false;
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('install', function(event) {
                    console.log('Service Worker installed');
                });
                
                self.addEventListener('fetch', function(event) {
                    event.respondWith(fetch(event.request));
                });
            `));
        }
        
        // Extract URL parameters (for direct QR code links)
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                token: urlParams.get('token'),
                session: urlParams.get('session'),
                user: urlParams.get('user'),
                redirect: urlParams.get('redirect')
            };
        }
        
        // Initialize app
        function initializeApp() {
            const params = getUrlParameters();
            
            // If URL has parameters, this was accessed via QR code
            if (params.token || params.session) {
                showTokenInfo(params);
                document.getElementById('welcomeText').textContent = 'You arrived here by scanning a QR code! Your session is ready.';
                document.getElementById('scanBtn').style.display = 'none';
            }
            
            // Add install prompt for PWA
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });
        }
        
        function showTokenInfo(params) {
            const tokenInfo = document.getElementById('tokenInfo');
            const tokenValue = document.getElementById('tokenValue');
            
            if (params.token) {
                tokenValue.textContent = params.token;
                tokenInfo.style.display = 'block';
            } else if (params.session) {
                tokenValue.textContent = params.session;
                tokenInfo.style.display = 'block';
            }
        }
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install App';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #34C759;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
                z-index: 1000;
            `;
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('User choice:', outcome);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
        }
        
        async function startQRScanner() {
            try {
                // Check if QrScanner is loaded
                if (typeof QrScanner === 'undefined') {
                    showError('QR Scanner library not loaded. Please refresh and try again.');
                    return;
                }
                
                const video = document.getElementById('qr-video');
                const welcomeScreen = document.getElementById('welcomeScreen');
                const scannerScreen = document.getElementById('scannerScreen');
                const errorMessage = document.getElementById('errorMessage');
                
                // Hide welcome, show scanner
                welcomeScreen.classList.add('hidden');
                scannerScreen.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                // Initialize QR Scanner
                qrScanner = new QrScanner(
                    video,
                    result => onQrCodeScanned(result.data),
                    {
                        onDecodeError: err => {
                            console.log('Decode error:', err);
                        },
                        highlightScanRegion: true,
                        highlightCodeOutline: true,
                    }
                );
                
                await qrScanner.start();
                scannerActive = true;
                
            } catch (error) {
                console.error('Scanner start error:', error);
                showError('Camera access denied or not available. Please allow camera permissions and try again.');
            }
        }
        
        function onQrCodeScanned(data) {
            console.log('QR Code scanned:', data);
            stopQRScanner();
            
            // Process the scanned QR code
            if (data.startsWith('http://') || data.startsWith('https://')) {
                // If it's a URL, redirect to it
                handleQRRedirect(data);
            } else {
                // If it's just data, show it and proceed
                processQRData(data);
            }
        }
        
        function handleQRRedirect(url) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const scannerScreen = document.getElementById('scannerScreen');
            
            // Show success state
            scannerScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            
            // Update UI
            const card = document.querySelector('.welcome-card');
            card.innerHTML = `
                <div class="qr-icon" style="background: linear-gradient(45deg, #34C759, #28A745);">
                    <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h2 class="welcome-title">QR Code Detected!</h2>
                <p class="welcome-text">Redirecting to: <br><strong>${url}</strong></p>
                <div style="background: rgba(52, 199, 89, 0.1); border-radius: 12px; padding: 16px; margin: 20px 0; border-left: 4px solid #34C759;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Status:</div>
                    <div style="font-size: 16px; color: #34C759; font-weight: 600;">Redirecting in 3 seconds...</div>
                </div>
                <button class="action-btn" onclick="window.open('${url}', '_blank')">
                    Go Now
                </button>
            `;
            
            // Auto-redirect after 3 seconds
            setTimeout(() => {
                window.open(url, '_blank');
            }, 3000);
        }
        
        function processQRData(data) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const scannerScreen = document.getElementById('scannerScreen');
            
            scannerScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            
            // Show the scanned data
            document.getElementById('tokenInfo').style.display = 'block';
            document.getElementById('tokenValue').textContent = data;
            document.getElementById('welcomeText').textContent = 'QR Code scanned successfully! You can now proceed with authentication.';
        }
        
        function stopQRScanner() {
            if (qrScanner && scannerActive) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
                scannerActive = false;
            }
            
            // Show welcome, hide scanner
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('scannerScreen').classList.add('hidden');
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            stopQRScanner();
        }
        
        function handleManualLogin() {
            const button = document.getElementById('loginBtn');
            const card = document.querySelector('.welcome-card');
            
            // Add success animation
            card.classList.add('success-animation');
            button.textContent = 'Authenticating...';
            button.style.background = 'linear-gradient(45deg, #34C759, #28A745)';
            
            setTimeout(() => {
                button.textContent = 'Login Successful!';
                
                setTimeout(() => {
                    // Get URL parameters for redirect
                    const params = getUrlParameters();
                    const redirectUrl = params.redirect || 'https://example.com/dashboard';
                    
                    // Show success message
                    card.innerHTML = `
                        <div class="qr-icon" style="background: linear-gradient(45deg, #34C759, #28A745);">
                            <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <h2 class="welcome-title" style="color: #34C759;">Success!</h2>
                        <p class="welcome-text">Authentication completed successfully. You can now access the secure area.</p>
                        <div style="background: rgba(52, 199, 89, 0.1); border-radius: 12px; padding: 16px; border-left: 4px solid #34C759; margin-top: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Status:</div>
                            <div style="font-size: 16px; color: #34C759; font-weight: 600;">Authenticated âœ“</div>
                        </div>
                    `;
                }, 1000);
            }, 1500);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Handle iOS standalone mode
        if (window.navigator.standalone) {
            document.body.style.paddingTop = '0';
        }
        
        // Prevent zoom on iOS
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 500);
        });
        
        // Clean up scanner on page unload
        window.addEventListener('beforeunload', function() {
            if (qrScanner) {
                qrScanner.destroy();
            }
        });
    </script>
</body>
</html>