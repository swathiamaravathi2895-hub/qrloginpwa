<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecureLogin</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureLogin">
    <meta name="theme-color" content="#007AFF">
    
    <!-- Icons for PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMwMDdBRkYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI4IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xOCA4aC0xVjZjMC0yLjc2LTIuMjQtNS01LTVTNyAzLjI0IDcgNnYySDZjLTEuMSAwLTIgLjktMiAydjEwYzAgMS4xLjkgMiAyIDJoMTJjMS4xIDAgMi0uOSAyLTJWMTBjMC0xLjEtLjktMi0yLTJ6TTEyIDE3Yy0xLjEgMC0yLS45LTItMnMuOS0yIDItMiAyIC45IDIgMi0uOSAyLTIgMnpNMTUuMSA4SDguOVY2YzAtMS43MSAxLjM5LTMuMSAzLjEtMy4xczMuMSAxLjM5IDMuMSAzLjF2MnoiLz4KPHN2Zz4KPHN2Zz4=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .status-bar-spacer {
            height: env(safe-area-inset-top, 44px);
            background: rgba(0, 0, 0, 0.1);
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #007AFF, #34C759);
            border-radius: 16px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }
        
        .logo svg {
            width: 30px;
            height: 30px;
            fill: white;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .app-subtitle {
            font-size: 16px;
            color: #666;
            font-weight: 400;
        }
        
        .main-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .scanner-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 30px;
            display: none;
        }
        
        .qr-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            border-radius: 20px;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
        }
        
        .welcome-text {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        
        .action-btn {
            background: linear-gradient(45deg, #007AFF, #0056CC);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            margin-bottom: 15px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 122, 255, 0.4);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        .scan-btn {
            background: linear-gradient(45deg, #34C759, #28A745);
            box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
        }
        
        .scan-btn:hover {
            box-shadow: 0 6px 25px rgba(52, 199, 89, 0.4);
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #007AFF;
            border: 2px solid #007AFF;
        }
        
        .video-container {
            width: 100%;
            max-width: 350px;
            height: 350px;
            border-radius: 16px;
            overflow: hidden;
            margin: 20px auto;
            position: relative;
            background: #000;
            border: 3px solid #34C759;
        }
        
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 3px solid #00FF00;
            border-radius: 12px;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 2px solid rgba(0, 255, 0, 0.6);
            border-radius: 12px;
            animation: scannerPulse 1.5s infinite;
        }
        
        @keyframes scannerPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.02); }
        }
        
        .scanner-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            pointer-events: none;
        }
        
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #00FF00;
        }
        
        .corner.top-left {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
            border-radius: 12px 0 0 0;
        }
        
        .corner.top-right {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 12px 0 0;
        }
        
        .corner.bottom-left {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 12px;
        }
        
        .corner.bottom-right {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 12px 0;
        }
        
        .scan-status {
            color: #34C759;
            font-weight: 600;
            margin-top: 15px;
            font-size: 16px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 30px;
            display: none;
        }
        
        .auth-form {
            margin-top: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(0, 122, 255, 0.2);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .url-info {
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 25px;
            border-left: 4px solid #007AFF;
            text-align: left;
        }
        
        .url-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .url-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 14px;
            color: #007AFF;
            font-weight: 600;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 380px;
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #34C759, #28A745);
            border-radius: 10px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feature-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
        }
        
        .feature-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        .bottom-spacer {
            height: env(safe-area-inset-bottom, 20px);
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .error-message {
            background: rgba(255, 59, 48, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            border-left: 4px solid #FF3B30;
            color: #FF3B30;
            font-size: 14px;
            text-align: left;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* iPhone 14 Pro Max specific optimizations */
        @media screen and (min-width: 428px) and (min-height: 926px) {
            .main-content {
                padding: 60px 30px;
            }
            
            .welcome-card, .login-card {
                padding: 50px 40px;
            }
            
            .app-title {
                font-size: 32px;
            }
            
            .welcome-title {
                font-size: 28px;
            }
            
            .video-container {
                max-width: 380px;
                height: 380px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar-spacer"></div>
        
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM15.1 8H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
                </svg>
            </div>
            <h1 class="app-title">SecureLogin</h1>
            <p class="app-subtitle">QR Code Authentication</p>
        </div>
        
        <div class="main-content">
            <!-- Welcome Screen -->
            <div class="welcome-card" id="welcomeScreen">
                <div class="qr-icon">
                    <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                        <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4z"/>
                        <path d="M18 13h-2v2h2v-2zM20 15h-2v2h2v-2zM22 13h-2v2h2v-2zM18 17h-2v2h2v-2zM20 19h-2v2h2v-2zM22 17h-2v4h2v-4z"/>
                    </svg>
                </div>
                
                <h2 class="welcome-title">Welcome!</h2>
                <p class="welcome-text">Scan a QR code to securely access protected files and resources.</p>
                
                <button class="action-btn scan-btn" onclick="startQRScanner()">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24" style="margin-right: 10px;">
                        <path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6.5 9.5v3h-3v-3h3M13 13h6v6h-6v-6z"/>
                    </svg>
                    Scan QR Code
                </button>
            </div>
            
            <!-- QR Scanner Screen -->
            <div class="scanner-card" id="scannerScreen">
                <h2 class="welcome-title">Scanning QR Code</h2>
                <p class="welcome-text">Point your camera at the QR code</p>
                
                <div class="video-container">
                    <video id="qr-video" playsinline muted></video>
                    <div class="scanner-overlay"></div>
                    <div class="scanner-corners">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                    </div>
                </div>
                
                <div class="scan-status" id="scanStatus">Looking for QR code...</div>
                
                <div class="error-message hidden" id="errorMessage"></div>
                
                <button class="action-btn secondary-btn" onclick="stopQRScanner()">
                    Cancel Scan
                </button>
            </div>
            
            <!-- Login Screen -->
            <div class="login-card" id="loginScreen">
                <div class="qr-icon" style="background: linear-gradient(45deg, #007AFF, #0056CC);">
                    <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                
                <h2 class="welcome-title">Authentication Required</h2>
                <p class="welcome-text">Please log in to access the protected resource.</p>
                
                <div class="url-info" id="urlInfo">
                    <div class="url-label">Requested Resource:</div>
                    <div class="url-value" id="targetUrl">Loading...</div>
                </div>
                
                <form class="auth-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="username">Username</label>
                        <input type="text" id="username" name="username" class="form-input" required placeholder="Enter your username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">Password</label>
                        <input type="password" id="password" name="password" class="form-input" required placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" class="action-btn" id="loginBtn">
                        Login & Access Resource
                    </button>
                </form>
            </div>
            
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Secure</div>
                    <div class="feature-desc">End-to-end encrypted authentication</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Fast</div>
                    <div class="feature-desc">Quick QR code recognition</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Reliable</div>
                    <div class="feature-desc">99.9% uptime guarantee</div>
                </div>
                
                <div class="feature">
                    <div class="feature-icon">
                        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 6L12 10.5 8.5 8 12 5.5 15.5 8zM8.5 16L12 13.5 15.5 16 12 18.5 8.5 16z"/>
                        </svg>
                    </div>
                    <div class="feature-title">Smart</div>
                    <div class="feature-desc">AI-powered security</div>
                </div>
            </div>
        </div>
        
        <div class="bottom-spacer"></div>
    </div>

    <script>
        let mediaStream = null;
        let scannerActive = false;
        let targetFileUrl = '';
        let scanInterval = null;
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('install', function(event) {
                    console.log('Service Worker installed');
                });
                
                self.addEventListener('fetch', function(event) {
                    event.respondWith(fetch(event.request));
                });
            `));
        }
        
        // QR Code detection using jsQR library
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js';
        document.head.appendChild(script);
        
        async function startQRScanner() {
            try {
                const video = document.getElementById('qr-video');
                const welcomeScreen = document.getElementById('welcomeScreen');
                const scannerScreen = document.getElementById('scannerScreen');
                const scanStatus = document.getElementById('scanStatus');
                const errorMessage = document.getElementById('errorMessage');
                
                // Hide welcome, show scanner
                welcomeScreen.classList.add('hidden');
                scannerScreen.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                
                // Request back camera specifically
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        facingMode: { exact: "environment" }, // Back camera
                        focusMode: "continuous"
                    }
                };
                
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (backCameraError) {
                    // Fallback to any available camera
                    console.log('Back camera not available, trying any camera:', backCameraError);
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            facingMode: "environment" // Prefer back camera but don't require it
                        }
                    });
                }
                
                video.srcObject = mediaStream;
                await video.play();
                scannerActive = true;
                
                scanStatus.textContent = 'Camera active - looking for QR code...';
                
                // Start scanning for QR codes
                startQRCodeDetection(video, scanStatus);
                
            } catch (error) {
                console.error('Scanner start error:', error);
                showError('Camera access denied or not available. Please allow camera permissions and try again.');
            }
        }
        
        function startQRCodeDetection(video, statusElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            scanInterval = setInterval(() => {
                if (!scannerActive || !video.videoWidth) return;
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        statusElement.textContent = 'QR Code detected! Processing...';
                        onQrCodeScanned(code.data);
                    }
                } else {
                    // Fallback pattern detection if jsQR is not loaded
                    statusElement.textContent = 'Camera active - point at QR code...';
                }
            }, 100);
        }
        
        function onQrCodeScanned(data) {
            console.log('QR Code scanned:', data);
            
            if (!data || typeof data !== 'string') return;
            
            stopQRScanner();
            
            // Store the target URL for later use
            targetFileUrl = data.trim();
            
            // Show login screen
            showLoginScreen(targetFileUrl);
        }
        
        function showLoginScreen(url) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const scannerScreen = document.getElementById('scannerScreen');
            const loginScreen = document.getElementById('loginScreen');
            const targetUrl = document.getElementById('targetUrl');
            
            // Hide other screens, show login
            welcomeScreen.classList.add('hidden');
            scannerScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Display the target URL
            targetUrl.textContent = url;
            
            // Focus on username field
            setTimeout(() => {
                document.getElementById('username').focus();
            }, 500);
        }
        
        function stopQRScanner() {
            scannerActive = false;
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Reset video
            const video = document.getElementById('qr-video');
            video.srcObject = null;
            
            // Show welcome, hide scanner
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('scannerScreen').classList.add('hidden');
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            const statusElement = document.getElementById('scanStatus');
            
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            statusElement.textContent = 'Scanner stopped due to error';
            
            stopQRScanner();
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Show loading state
            loginBtn.innerHTML = '<div class="loading-spinner"></div>Authenticating...';
            loginBtn.disabled = true;
            
            try {
                // Simulate authentication (replace with your actual auth logic)
                const authResult = await authenticateUser(username, password);
                
                if (authResult.success) {
                    // Show success state
                    loginBtn.innerHTML = '<svg width="20" height="20" fill="white" viewBox="0 0 24 24" style="margin-right: 8px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>Login Successful!';
                    loginBtn.style.background = 'linear-gradient(45deg, #34C759, #28A745)';
                    
                    // Wait a moment, then redirect to the original file URL
                    setTimeout(() => {
                        if (targetFileUrl) {
                            // Navigate to the original file URL in the same tab
                            window.location.href = targetFileUrl;
                        } else {
                            // Fallback redirect
                            showSuccessMessage();
                        }
                    }, 1500);
                    
                } else {
                    throw new Error(authResult.message || 'Authentication failed');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error state
                loginBtn.innerHTML = 'Login Failed - Try Again';
                loginBtn.style.background = 'linear-gradient(45deg, #FF3B30, #FF6B6B)';
                loginBtn.disabled = false;
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    loginBtn.innerHTML = 'Login & Access Resource';
                    loginBtn.style.background = 'linear-gradient(45deg, #007AFF, #0056CC)';
                }, 3000);
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Invalid credentials. Please try again.';
                errorDiv.style.margin = '15px 0 0 0';
                
                const form = document.querySelector('.auth-form');
                const existingError = form.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }
                form.appendChild(errorDiv);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }
        }
        
        // Mock authentication function - replace with your actual authentication logic
        async function authenticateUser(username, password) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Mock authentication - replace this with actual API call
                    if (username === 'demo' && password === 'password') {
                        resolve({ success: true, token: 'mock-jwt-token' });
                    } else if (username.length > 0 && password.length > 0) {
                        // For demo purposes, accept any non-empty credentials
                        resolve({ success: true, token: 'mock-jwt-token' });
                    } else {
                        resolve({ success: false, message: 'Invalid credentials' });
                    }
                }, 1500); // Simulate network delay
            });
        }
        
        function showSuccessMessage() {
            const loginScreen = document.getElementById('loginScreen');
            
            loginScreen.innerHTML = `
                <div class="qr-icon" style="background: linear-gradient(45deg, #34C759, #28A745);">
                    <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h2 class="welcome-title" style="color: #34C759;">Access Granted!</h2>
                <p class="welcome-text">Authentication successful. You now have access to the protected resource.</p>
                <div style="background: rgba(52, 199, 89, 0.1); border-radius: 12px; padding: 16px; border-left: 4px solid #34C759; margin-top: 20px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Status:</div>
                    <div style="font-size: 16px; color: #34C759; font-weight: 600;">Authenticated âœ“</div>
                </div>
                <button class="action-btn" onclick="resetApp()" style="margin-top: 25px;">
                    Scan Another QR Code
                </button>
            `;
        }
        
        function resetApp() {
            // Reset all variables
            targetFileUrl = '';
            scannerActive = false;
            
            // Hide all screens except welcome
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('scannerScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            
            // Reset form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Reset login button
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = 'Login & Access Resource';
            loginBtn.style.background = 'linear-gradient(45deg, #007AFF, #0056CC)';
            loginBtn.disabled = false;
        }
        
        // Initialize app
        function initializeApp() {
            // Add install prompt for PWA
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });
            
            // Handle app install
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
            });
        }
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install App';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #34C759;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
                z-index: 1000;
            `;
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('User choice:', outcome);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Handle iOS standalone mode
        if (window.navigator.standalone) {
            document.body.style.paddingTop = '0';
        }
        
        // Prevent zoom on iOS
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 500);
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (scanInterval) {
                clearInterval(scanInterval);
            }
        });
        
        // Handle back button
        window.addEventListener('popstate', function(event) {
            if (scannerActive) {
                stopQRScanner();
            }
        });
    </script>
</body>
</html>
